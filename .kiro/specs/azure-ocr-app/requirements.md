# 要件定義書

## 概要

KoEReq OCR (Azure Edition)は、医療文書（お薬手帳、紹介状、リハビリチェックリスト）を撮影し、Azure Document Intelligence（DI）を使用してOCR解析を行うiOS/SwiftUIアプリケーションです。アプリ起動時に即座にカメラが起動し、撮影後に文書タイプを選択してAI解析を実行します。解析結果のテキストはユーザーが編集可能で、確認後にQRコード生成とセッション保存を行います。カメラ画面の設定から独自の文書タイプとプロンプトを管理できます。App StoreとApple Business Manager（ABM）の両方での配布に対応し、IAP（In-App Purchase）サブスクリプションモデルを採用します。

## 要件

### 要件1: カメラファースト起動機能

**ユーザーストーリー:** ユーザーとして、アプリを開いたら即座に撮影を開始したいので、アプリ起動時にカメラ画面が表示される。

#### 受入基準

1. WHEN ユーザーがアプリを起動する THEN システムは即座にカメラ画面を表示する SHALL
2. WHEN カメラ画面が表示される THEN システムは撮影ガイド枠を表示する SHALL
3. WHEN カメラ画面が表示される THEN システムは右上に設定ボタン（⚙️）を配置する SHALL
4. WHEN ユーザーがシャッターを押す THEN システムは撮影画像をプレビュー表示する SHALL
5. WHEN カメラ画面が表示される THEN システムは「AIでテキスト化」ボタンを配置する SHALL

### 要件2: 設定画面機能

**ユーザーストーリー:** ユーザーとして、オリジナル文書タイプの管理と保存済みデータの確認を行いたいので、設定画面から両方の機能にアクセスできる。

#### 受入基準

1. WHEN ユーザーが設定ボタン（⚙️）を押す THEN システムは設定画面を表示する SHALL
2. WHEN 設定画面が表示される THEN システムは「オリジナル文書編集」と「ストレージ確認」の2つのメニューを提供する SHALL
3. WHEN 「オリジナル文書編集」が選択される THEN システムは既存のオリジナル文書タイプ一覧を表示する SHALL
4. WHEN オリジナル文書一覧が表示される THEN システムは「新規作成」ボタンを提供する SHALL
5. WHEN ユーザーが「新規作成」を選択する THEN システムは文書名入力フィールドとプロンプト入力フィールドを表示する SHALL
6. WHEN ユーザーが文書名とプロンプトを入力する THEN システムは入力内容をローカルに保存する SHALL
7. WHEN 既存のオリジナル文書が選択される THEN システムは編集・削除オプションを提供する SHALL
8. WHEN 「ストレージ確認」が選択される THEN システムは保存済みセッション一覧を表示する SHALL

### 要件3: 連続撮影機能

**ユーザーストーリー:** ユーザーとして、必要な枚数を連続して撮影したいので、シャッターを押すたびに画像が蓄積され、撮影完了は「AIでテキスト化」ボタンで決定する。

#### 受入基準

1. WHEN ユーザーがシャッターを押す THEN システムは撮影画像を内部に蓄積する SHALL
2. WHEN 画像が蓄積される THEN システムは撮影済み枚数を画面に表示する SHALL
3. WHEN ユーザーが「AIでテキスト化」ボタンを押す THEN システムは撮影を完了し文書タイプ選択の円形メニューを表示する SHALL
4. WHEN 撮影枚数が0枚の状態で「AIでテキスト化」が押される THEN システムは「写真を撮影してください」メッセージを表示する SHALL
5. WHEN 複数枚撮影済みの場合 THEN システムは「○枚撮影済み」を表示する SHALL

### 要件4: 円形文書タイプ選択とテキスト化開始

**ユーザーストーリー:** ユーザーとして、撮影完了後に文書の種類を素早く選択してテキスト化を開始したいので、円形に配置された文書タイプボタンから直感的に選択できる。

#### 受入基準

1. WHEN 「AIでテキスト化」が選択される THEN システムは円形に配置された文書タイプボタンを表示する SHALL
2. WHEN 円形メニューが表示される THEN システムは「紹介状」「お薬手帳」「一般テキスト」および保存済みオリジナル文書タイプのボタンを円形に配置する SHALL
3. WHEN ユーザーが文書タイプを選択する THEN システムは該当タイプ専用のLLMプロンプトを準備して解析を開始する SHALL
4. WHEN 文書タイプが選択される THEN システムは円形メニューを閉じてテキスト化ビューに遷移する SHALL
5. WHEN テキスト化ビューに遷移する THEN システムはUIを解析結果表示画面に変更する SHALL
6. WHEN オリジナル文書タイプが多数ある場合 THEN システムはスクロール可能な円形メニューを提供する SHALL

### 要件5: Azure Blob ストレージ連携

**ユーザーストーリー:** システム管理者として、撮影された画像を安全にクラウドストレージに保存したいので、Private EndpointとManaged Identityを使用したセキュアな保存が行われる。

#### 受入基準

1. WHEN 画像アップロードが開始される THEN システムはAzure FunctionsからSAS URLを取得する SHALL
2. WHEN SAS URLを取得する THEN システムはコンテナ名とファイル名をパラメータとして送信する SHALL
3. WHEN SAS URLが取得される THEN システムはPUTメソッドでraw/<docId>.jpgとして画像をアップロードする SHALL
4. WHEN アップロードが完了する THEN システムは監査ログに「captured」「uploaded」イベントを記録する SHALL
5. IF アップロードが失敗する THEN システムはローカルキューに退避し指数バックオフで再送する SHALL

### 要件6: Azure AI解析とLLMプロンプト処理

**ユーザーストーリー:** ユーザーとして、アップロードした医療文書からテキスト情報を自動抽出したいので、Azure DIとLLMを使用し、選択された文書タイプに応じた専用プロンプトでテキスト形式の解析結果が返される。

#### 受入基準

1. WHEN 画像アップロードが完了する THEN システムはAzure DI解析APIを呼び出す SHALL
2. WHEN DI解析APIを呼び出す THEN システムはdocIdと選択された文書タイプをパラメータとして送信する SHALL
3. WHEN DI解析が完了する THEN システムはOCRで抽出されたテキストを取得する SHALL
4. WHEN 文書タイプが「紹介状」の場合 THEN システムは紹介状専用プロンプトとOCRテキストをLLM（Azure OpenAI）に送信する SHALL
5. WHEN 文書タイプが「お薬手帳」の場合 THEN システムはお薬手帳専用プロンプトとOCRテキストをLLM（Azure OpenAI）に送信する SHALL
6. WHEN 文書タイプが「一般テキスト」の場合 THEN システムは一般テキスト専用プロンプトとOCRテキストをLLM（Azure OpenAI）に送信する SHALL
7. WHEN 文書タイプがオリジナルの場合 THEN システムはユーザー定義プロンプトとOCRテキストをLLM（Azure OpenAI）に送信する SHALL
8. WHEN LLMから結果を受け取る THEN システムは構造化されたテキスト形式の解析結果を受け取る SHALL
9. WHEN チェックボックスが検出される THEN LLMはチェックボックスの項目数をカウントして返す SHALL
10. WHEN 解析が完了する THEN システムは監査ログに「analysis_done」イベントを記録する SHALL

### 要件7: 解析結果表示と編集機能

**ユーザーストーリー:** ユーザーとして、AI解析結果をテキスト形式で確認し、必要に応じて編集したいので、編集可能なテキスト表示と再解析オプションが提供される。

#### 受入基準

1. WHEN 結果画面が表示される THEN システムはAIから返されたテキスト解析結果を編集可能なテキストフィールドに表示する SHALL
2. WHEN テキスト結果が表示される THEN システムは本文、表データ、チェックボックス項目数を区別して表示する SHALL
3. WHEN ユーザーがテキストを編集する THEN システムはリアルタイムで変更を反映する SHALL
4. WHEN 結果画面が表示される THEN システムは「取り直し」ボタンを提供する SHALL
5. WHEN ユーザーが「取り直し」を選択する THEN システムはカメラ画面に戻る SHALL
6. WHEN 複数枚の画像を解析した場合 THEN システムは各画像の解析結果を区別して編集可能にする SHALL
7. WHEN ユーザーがテキスト内容を確認する THEN システムは「QR生成」ボタンを提供する SHALL

### 要件8: QRコード生成とクラウド・ローカル保存機能

**ユーザーストーリー:** ユーザーとして、確認済みのテキスト情報をQRコードで共有し、そのセッションをクラウドとローカルの両方に保存したいので、QR生成と同時に自動保存される。

#### 受入基準

1. WHEN ユーザーが「QR生成」ボタンを押す THEN システムはQRコードモーダルを表示する SHALL
2. WHEN QRコードモーダルが表示される THEN システムは編集済みテキストをQRコードとして生成する SHALL
3. WHEN QRコードが生成される THEN システムはユーザーが画像として保存できるオプションを提供する SHALL
4. WHEN QRコードが生成される THEN システムは自動的にセッション情報（画像、テキスト、文書タイプ、作成日時）をローカルストレージに保存する SHALL
5. WHEN ローカル保存が完了する THEN システムは同じセッション情報をクラウドストレージ（Azure Blob）にも保存する SHALL
6. WHEN 複数枚の解析結果がある場合 THEN システムは統合されたテキストをQRコードにする SHALL
7. WHEN セッション保存が完了する THEN システムは監査ログに「session_saved」イベントを記録する SHALL

### 要件9: ストレージ確認機能

**ユーザーストーリー:** ユーザーとして、過去に保存したセッションを確認したいので、設定画面のストレージ確認から既存のセッション結果を検索・表示できる。

#### 受入基準

1. WHEN 設定画面から「ストレージ確認」が選択される THEN システムは保存済みセッションのリストを表示する SHALL
2. WHEN ストレージ確認画面が表示される THEN システムは検索バーを提供する SHALL
3. WHEN ユーザーが検索バーにテキストを入力する THEN システムは該当するセッションをフィルタリングする SHALL
4. WHEN ユーザーがセッション項目を選択する THEN システムは既存のセッション結果を読み込んでテキスト化ビューを表示する SHALL
5. WHEN 過去のセッションが表示される THEN システムはテキスト編集とQR再生成を可能にする SHALL
6. WHEN ストレージ確認画面が表示される THEN システムはローカルとクラウドの両方のデータを統合して表示する SHALL

### 要件10: IAPサブスクリプション管理

**ユーザーストーリー:** ユーザーとして、月次のOCR解析ページ数に応じたサブスクリプションプランを選択したいので、Light（100ページ）、Standard（300ページ）、Pro（1000ページ）の3つのプランから選択できる。

#### 受入基準

1. WHEN アプリが初回起動される THEN システムは7日間の無料トライアルを提供する SHALL
2. WHEN ユーザーがOCR解析を実行する THEN システムは月次ページ数制限をチェックする SHALL
3. WHEN 月次制限に達する THEN システムはアップグレードを促すメッセージを表示する SHALL
4. WHEN ユーザーがサブスクリプションを購入する THEN システムは該当プランの月次制限を適用する SHALL
5. WHEN 月が変わる THEN システムはページ数カウンターをリセットする SHALL

### 要件11: エラーハンドリングと再送機能

**ユーザーストーリー:** システム管理者として、ネットワーク障害や一時的なサービス停止に対して堅牢性を確保したいので、自動再送機能と適切なエラー通知が提供される。

#### 受入基準

1. WHEN 通信エラーが発生する THEN システムは処理をローカルキューに退避する SHALL
2. WHEN ローカルキューに退避される THEN システムは指数バックオフアルゴリズムで再送を試行する SHALL
3. WHEN 24時間を超えて再送が失敗する THEN システムはアプリバッジで未送信件数を表示する SHALL
4. WHEN エラーが発生する THEN システムは監査ログに「error」イベントとエラー詳細を記録する SHALL
5. WHEN ネットワークが復旧する THEN システムは自動的にキューの処理を再開する SHALL

### 要件12: プライバシーとセキュリティ

**ユーザーストーリー:** ユーザーとして、個人の医療情報が適切に保護されることを期待するので、プライバシー準拠とセキュアなデータ処理が実装される。

#### 受入基準

1. WHEN アプリがユーザーデータを収集する THEN システムはApp Privacy Manifestに従って匿名化IDのみを使用する SHALL
2. WHEN 画像データを処理する THEN システムはユーザーが明示的にアップロードした文書のみを対象とする SHALL
3. WHEN データを保存する THEN システムはPrivate EndpointとManaged Identityを使用する SHALL
4. WHEN アプリが起動する THEN システムはトラッキングを実行しない SHALL
5. WHEN カメラや写真ライブラリにアクセスする THEN システムは適切な使用目的説明を表示する SHALL
6. WHEN DB内のデータにアクセスする THEN システムは読み取り専用でアクセスし、変更は行わない SHALL