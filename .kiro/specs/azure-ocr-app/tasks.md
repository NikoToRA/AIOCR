# 実装計画

## 概要

この実装計画は、KoEReq OCR (Azure Edition)アプリの開発を段階的に進めるためのタスクリストです。各タスクはテスト駆動開発（TDD）アプローチを採用し、小さな増分で機能を構築していきます。

## タスクリスト

- [ ] 1. プロジェクト基盤とデータモデル構築
  - Xcodeプロジェクト作成、Azure SDK統合、基本データモデル実装
  - _要件: 1.1, 2.1, 6.1_

- [ ] 1.1 Xcodeプロジェクトセットアップと依存関係管理
  - iOS 17.0対応のSwiftUIプロジェクト作成
  - Package.swiftでAzure SDK、QRCode、AnyCodable依存関係追加
  - Info.plistにAzure設定とプライバシー使用説明追加
  - _要件: 12.4, 12.5_

- [ ] 1.2 基本データモデルとプロトコル定義
  - SessionData、DocumentType、CustomPrompt、OCRResult、StructuredTextモデル実装
  - CameraService、AzureStorageService、DocumentIntelligenceService、OpenAIService、LocalStorageServiceプロトコル定義
  - AppError列挙型とエラーハンドリング基盤実装
  - _要件: 6.8, 11.4_

- [ ] 1.3 基本データモデルのユニットテスト
  - 各データモデルのCodable準拠テスト
  - エラーハンドリングのテストケース作成
  - プロトコル準拠の基本テスト実装
  - _要件: 6.8_

- [ ] 2. ローカルストレージ機能実装
  - Core Dataまたは UserDefaults を使用したローカルデータ永続化
  - _要件: 8.4, 9.1_

- [ ] 2.1 LocalStorageService実装
  - UserDefaultsベースのセッション保存・読み込み機能
  - カスタムプロンプトの保存・読み込み機能
  - データ暗号化とセキュア保存実装
  - _要件: 8.4, 2.6_

- [ ] 2.2 LocalStorageServiceのユニットテスト
  - セッション保存・読み込みテスト
  - カスタムプロンプト管理テスト
  - データ整合性とエラーハンドリングテスト
  - _要件: 8.4, 2.6_

- [ ] 3. カメラ機能とUI基盤実装
  - SwiftUIベースのカメラビューと撮影機能
  - _要件: 1.1, 1.4, 3.1_

- [ ] 3.1 CameraService実装
  - AVFoundationを使用したカメラ制御
  - 画像撮影と蓄積機能
  - カメラ権限管理とエラーハンドリング
  - _要件: 1.1, 1.4, 3.1, 12.5_

- [ ] 3.2 CameraViewのSwiftUI実装
  - リアルタイムカメラプレビュー表示
  - 撮影ガイド枠とシャッターボタン
  - 撮影枚数カウンター表示
  - 設定ボタン（⚙️）配置
  - _要件: 1.1, 1.2, 1.3, 3.2_

- [ ] 3.3 CameraViewのユニットテスト
  - カメラサービス連携テスト
  - UI状態管理テスト
  - 権限エラーハンドリングテスト
  - _要件: 1.1, 3.1_

- [ ] 4. 設定画面とオリジナルプロンプト管理
  - 設定UI、カスタムプロンプト作成・編集機能
  - _要件: 2.2, 2.3, 2.5_

- [ ] 4.1 SettingsView実装
  - 「オリジナル文書編集」「ストレージ確認」メニュー
  - ナビゲーション構造とUI実装
  - _要件: 2.2_

- [ ] 4.2 CustomPromptEditor実装
  - プロンプト一覧表示、新規作成、編集、削除機能
  - 文書名とプロンプト入力フィールド
  - バリデーションとエラー表示
  - _要件: 2.3, 2.5, 2.6, 2.7_

- [ ] 4.3 CustomPromptEditorのユニットテスト
  - プロンプト作成・編集・削除テスト
  - バリデーションロジックテスト
  - LocalStorageService連携テスト
  - _要件: 2.5, 2.6, 2.7_

- [ ] 5. 円形文書タイプ選択UI実装
  - 「AIでテキスト化」後の円形メニュー
  - _要件: 4.1, 4.2, 4.3_

- [ ] 5.1 CircularDocumentTypeSelector実装
  - 円形レイアウトでボタン配置
  - プリセット文書タイプ（紹介状、お薬手帳、一般テキスト）表示
  - オリジナル文書タイプ動的表示
  - アニメーション効果とタップハンドリング
  - _要件: 4.1, 4.2, 4.6_

- [ ] 5.2 CircularDocumentTypeSelectorのユニットテスト
  - 円形レイアウト計算テスト
  - 文書タイプ選択イベントテスト
  - オリジナル文書タイプ表示テスト
  - _要件: 4.1, 4.2_

- [ ] 6. Azure Blob Storage連携実装
  - 画像アップロード、SAS URL取得機能
  - _要件: 5.1, 5.2, 5.3_

- [ ] 6.1 AzureStorageService実装
  - SAS URL取得機能
  - 画像のPUTアップロード機能
  - セッションデータのクラウド保存
  - 指数バックオフ再送機能
  - _要件: 5.1, 5.2, 5.3, 5.5, 11.1, 11.2_

- [ ] 6.2 AzureStorageServiceのユニットテスト
  - SAS URL取得テスト（モック使用）
  - 画像アップロードテスト
  - エラーハンドリングと再送テスト
  - _要件: 5.1, 5.3, 11.1, 11.2_

- [ ] 7. Azure Document Intelligence連携実装
  - OCR解析API呼び出し機能
  - _要件: 6.1, 6.2, 6.3_

- [ ] 7.1 DocumentIntelligenceService実装
  - Azure DI Read+Layout API呼び出し
  - OCRResult構造体へのレスポンス変換
  - エラーハンドリングと再送機能
  - _要件: 6.1, 6.2, 6.3, 11.1_

- [ ] 7.2 DocumentIntelligenceServiceのユニットテスト
  - API呼び出しテスト（モック使用）
  - レスポンス変換テスト
  - エラーケースハンドリングテスト
  - _要件: 6.1, 6.3_

- [ ] 8. 個人情報マスキング機能実装
  - OCRテキストの個人情報検出・マスキング処理
  - _要件: 12.1, 12.2_

- [ ] 8.1 PIIMaskingService実装
  - 正規表現による個人情報パターン検出（名前、生年月日、電話番号、住所等）
  - 検出された個人情報のマスキング処理（[名前]、[生年月日]等のプレースホルダー置換）
  - 医療文書特有の個人情報パターン対応
  - マスキング前後のテキスト管理機能
  - _要件: 12.1, 12.2_

- [ ] 8.2 PIIMaskingServiceのユニットテスト
  - 各種個人情報パターン検出テスト
  - マスキング処理の正確性テスト
  - 医療文書特有パターンのテスト
  - _要件: 12.1, 12.2_

- [ ] 9. Azure OpenAI連携とプロンプト処理実装
  - LLMプロンプト送信、構造化テキスト取得（マスキング済みテキスト使用）
  - _要件: 6.4, 6.5, 6.6, 6.7_

- [ ] 9.1 PromptManager実装
  - プリセットプロンプトテンプレート管理
  - 文書タイプ別プロンプト選択ロジック
  - オリジナルプロンプト統合機能
  - マスキング済みOCRテキストとプロンプトの結合処理
  - _要件: 6.4, 6.5, 6.6, 6.7_

- [ ] 9.2 OpenAIService実装
  - Azure OpenAI API呼び出し
  - プロンプト + マスキング済みテキスト送信
  - StructuredText形式でのレスポンス受信
  - チェックボックスカウント処理
  - _要件: 6.4, 6.5, 6.6, 6.7, 6.8, 6.9_

- [ ] 9.3 OpenAIServiceとPromptManagerのユニットテスト
  - プロンプト選択ロジックテスト
  - API呼び出しテスト（モック使用）
  - レスポンス変換テスト
  - マスキング済みテキスト処理テスト
  - エラーハンドリングテスト
  - _要件: 6.4, 6.8_

- [ ] 10. 文書処理統合とビジネスロジック実装
  - 撮影からテキスト化までの全体フロー制御（個人情報マスキング含む）
  - _要件: 3.3, 4.4, 6.10_

- [ ] 10.1 DocumentProcessor実装
  - 画像アップロード → DI解析 → 個人情報マスキング → LLM処理の統合フロー
  - 複数画像の並列処理
  - 進捗表示とエラーハンドリング
  - 監査ログ記録機能（マスキング処理含む）
  - _要件: 3.3, 4.4, 5.4, 6.10, 11.4, 12.1_

- [ ] 10.2 DocumentProcessorのユニットテスト
  - 統合フロー実行テスト（マスキング処理含む）
  - エラー時の適切な処理テスト
  - 監査ログ記録テスト
  - _要件: 6.10, 11.4, 12.1_

- [ ] 11. テキスト解析結果表示と編集機能実装
  - 解析結果UI、テキスト編集機能（マスキング解除オプション含む）
  - _要件: 7.1, 7.3, 7.4, 7.7_

- [ ] 11.1 TextAnalysisView実装
  - 編集可能テキストフィールド表示（LLM処理済みテキスト）
  - 「取り直し」「QR生成」ボタン
  - 「元のテキスト表示」トグル機能（マスキング前のOCRテキスト表示）
  - 複数画像結果の区別表示
  - リアルタイムテキスト編集機能
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.7, 12.1_

- [ ] 11.2 TextAnalysisViewのユニットテスト
  - テキスト表示・編集機能テスト
  - マスキング前後テキスト切り替えテスト
  - ボタンアクションテスト
  - 複数結果表示テスト
  - _要件: 7.1, 7.3, 7.7, 12.1_

- [ ] 12. QRコード生成とセッション保存機能実装
  - QR生成、ローカル・クラウド保存
  - _要件: 8.1, 8.4, 8.5, 8.7_

- [ ] 12.1 QRCodeGenerator実装
  - テキストからQRコード画像生成
  - 複数画像結果の統合処理
  - QRコード画像保存機能
  - _要件: 8.1, 8.2, 8.3, 8.5_

- [ ] 12.2 SessionManager実装
  - セッション作成・保存機能（マスキング前後両方のテキスト保存）
  - ローカル・クラウド同期処理
  - 監査ログ記録
  - _要件: 8.4, 8.5, 8.7, 12.1_

- [ ] 12.3 QRCodeGeneratorとSessionManagerのユニットテスト
  - QRコード生成テスト
  - セッション保存テスト（マスキング情報含む）
  - 同期処理テスト
  - _要件: 8.1, 8.4, 8.7, 12.1_

- [ ] 13. ストレージ確認とセッション履歴機能実装
  - 保存済みセッション閲覧、検索機能
  - _要件: 9.1, 9.3, 9.4, 9.6_

- [ ] 13.1 StorageBrowser実装
  - セッション一覧表示
  - 検索・フィルタリング機能
  - セッション詳細表示（マスキング前後テキスト切り替え含む）
  - ローカル・クラウドデータ統合表示
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.6, 12.1_

- [ ] 13.2 StorageBrowserのユニットテスト
  - セッション一覧表示テスト
  - 検索・フィルタリングテスト
  - データ統合表示テスト
  - マスキング情報表示テスト
  - _要件: 9.1, 9.3, 9.4, 12.1_

- [ ] 14. IAPサブスクリプション機能実装
  - App Store Connect連携、使用量制限
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 14.1 SubscriptionManager実装
  - StoreKitを使用したIAP処理
  - サブスクリプション状態管理
  - 月次ページ数制限チェック
  - 7日間無料トライアル実装
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 14.2 SubscriptionManagerのユニットテスト
  - IAP処理テスト（モック使用）
  - 制限チェックテスト
  - トライアル期間管理テスト
  - _要件: 10.1, 10.2, 10.3_

- [ ] 15. 統合テストとエラーハンドリング強化
  - エンドツーエンドフロー、エラー処理
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 15.1 エラーハンドリング統合実装
  - RetryManager実装
  - ネットワークエラー処理
  - ユーザーフレンドリーなエラーメッセージ
  - アプリバッジ表示機能
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 15.2 統合テスト実装
  - 撮影からQR生成までの完全フローテスト（個人情報マスキング含む）
  - エラー発生時の適切な処理テスト
  - オフライン・オンライン切り替えテスト
  - _要件: 11.1, 11.5, 12.1_

- [ ] 16. UIテストとアクセシビリティ対応
  - UI自動化テスト、アクセシビリティ機能
  - _要件: 1.1, 12.4, 12.5_

- [ ] 16.1 UIテスト実装
  - カメラフローUIテスト
  - 設定画面UIテスト
  - ストレージ確認UIテスト
  - 個人情報マスキング機能UIテスト
  - エラー状態UIテスト
  - _要件: 1.1, 2.2, 9.1, 12.1_

- [ ] 16.2 アクセシビリティ対応実装
  - VoiceOver対応
  - Dynamic Type対応
  - アクセシビリティラベル・ヒント追加
  - _要件: 12.4, 12.5_

- [ ] 17. パフォーマンス最適化と監査ログ実装
  - メモリ最適化、ログ機能
  - _要件: 11.4_

- [ ] 17.1 パフォーマンス最適化実装
  - 画像圧縮・リサイズ処理
  - メモリ使用量最適化
  - ネットワーク処理最適化
  - バックグラウンド処理実装
  - _要件: 11.4_

- [ ] 17.2 監査ログシステム実装
  - AuditLog構造体とイベント記録（個人情報マスキング処理含む）
  - ローカル・クラウドログ保存
  - ログローテーション機能
  - _要件: 11.4, 12.1_

- [ ] 18. 最終統合とリリース準備
  - 全機能統合、App Store準備
  - _要件: 12.1, 12.2, 12.3, 12.6_

- [ ] 18.1 App Store Connect設定
  - アプリメタデータ設定
  - スクリーンショット準備
  - プライバシーポリシー・サポートURL設定（個人情報マスキング機能の説明含む）
  - IAP商品設定
  - _要件: 12.1, 12.2, 12.3_

- [ ] 18.2 最終テストとバグ修正
  - 全機能の統合テスト（個人情報マスキング機能含む）
  - パフォーマンステスト
  - セキュリティテスト（個人情報保護検証含む）
  - バグ修正とコード最適化
  - _要件: 12.6, 12.1_

- [ ] 18.3 リリースビルド作成
  - プロダクションビルド設定
  - コード署名とプロビジョニング
  - App Store提出準備
  - _要件: 12.1_