# あなたが行う必要がある作業

## 現在の状況

✅ **完了済み**
- Azure Functions バックエンドの実装
- iOS アプリの Azure 連携コード
- 設定ファイルとデプロイスクリプト
- 完全なセットアップガイド

## あなたが行う必要がある作業

### 1. 開発環境のセットアップ

#### 1.1 Azure Functions Core Tools のインストール
```bash
# macOS の場合
brew tap azure/functions
brew install azure-functions-core-tools@4

# インストール確認
func --version
```

#### 1.2 Python 環境の確認
```bash
# Python 3.10+ が必要（現在は 3.13.7 で OK）
python3 --version
```

### 2. Azure アカウントと Azure CLI の設定

#### 2.1 Azure にログイン
```bash
az login
```

#### 2.2 適切なサブスクリプションを選択
```bash
# サブスクリプション一覧を確認
az account list

# 使用するサブスクリプションを設定
az account set --subscription "your-subscription-id"
```

### 3. Azure リソースの作成

#### 3.1 プロビジョニングスクリプトの実行
```bash
cd azure/functions/scripts
chmod +x provision.sh
./provision.sh
```

**重要**: スクリプト実行後に表示される以下の情報をメモしてください：
- Function App 名
- Storage Account 名
- Document Intelligence エンドポイント
- 各種キー

#### 3.2 Azure OpenAI の手動作成
Azure Portal で以下を作成：
1. Azure OpenAI リソース
2. `gpt-4o` モデルをデプロイ（デプロイ名: `gpt-4o`）
3. エンドポイントとキーをメモ

### 4. Azure Functions のデプロイ

#### 4.1 Function App に OpenAI 設定を追加
```bash
# プロビジョニング後に取得した情報を使用
FUNCTION_APP_NAME="your-function-app-name"
OPENAI_ENDPOINT="https://your-openai.openai.azure.com/"
OPENAI_KEY="your-openai-key"

az functionapp config appsettings set \
  -g koereq-ocr-rg -n $FUNCTION_APP_NAME \
  --settings \
  AZURE_OPENAI_ENDPOINT="$OPENAI_ENDPOINT" \
  AZURE_OPENAI_KEY="$OPENAI_KEY"
```

#### 4.2 Functions をデプロイ
```bash
cd azure/functions
pip3 install -r requirements.txt
func azure functionapp publish $FUNCTION_APP_NAME
```

#### 4.3 Function Key の取得
```bash
az functionapp keys list -g koereq-ocr-rg -n $FUNCTION_APP_NAME
```

### 5. iOS プロジェクトのセットアップ

#### 5.1 新しい Xcode プロジェクトの作成
現在のプロジェクト構造に問題があるため、新しく作成することを推奨：

1. Xcode で新しいプロジェクトを作成
   - iOS App
   - Interface: SwiftUI
   - Language: Swift
   - Product Name: `KoEReqOCR`
   - Minimum iOS: 17.0

2. プロジェクト作成後、以下のファイルを追加：
   ```
   ios/KoEReqOCR/Sources/ の内容を新しいプロジェクトにドラッグ&ドロップ
   ```

#### 5.2 Info.plist の更新
作成したプロジェクトの Info.plist に以下を追加：

```xml
<key>NSCameraUsageDescription</key>
<string>カメラで文書を撮影します</string>
<key>NSPhotoLibraryAddUsageDescription</key>
<string>撮影画像の保存に使用します</string>

<!-- Azure 設定（ステップ4で取得した実際の値を使用） -->
<key>AZURE_FUNCTIONS_BASE_URL</key>
<string>https://your-function-app.azurewebsites.net/api</string>
<key>AZURE_FUNCTIONS_KEY</key>
<string>your-function-key</string>
<key>AZURE_OPENAI_ENDPOINT</key>
<string>https://your-openai.openai.azure.com</string>
<key>AZURE_OPENAI_DEPLOYMENT</key>
<string>gpt-4o</string>
```

### 6. 動作テスト

#### 6.1 Azure Functions のテスト
```bash
# SAS URL 発行テスト
curl -X POST https://your-function-app.azurewebsites.net/api/issueUploadUrls \
  -H "Content-Type: application/json" \
  -H "x-functions-key: YOUR_FUNCTION_KEY" \
  -d '{"count": 1}'
```

#### 6.2 iOS アプリのテスト
1. Xcode でビルド・実行
2. カメラ権限を許可
3. 文書を撮影
4. 「AIでテキスト化」→文書タイプ選択
5. Azure 経由で処理されることを確認

## 予想される所要時間

- Azure リソース作成: 15-30分
- Functions デプロイ: 10-15分
- iOS プロジェクト再作成: 20-30分
- テスト・調整: 15-30分

**合計: 約1-2時間**

## トラブルシューティング

### よくある問題

#### Azure Functions が起動しない
```bash
# ログの確認
func azure functionapp logstream $FUNCTION_APP_NAME
```

#### iOS アプリがスタブ実装のまま
- Info.plist の Azure 設定が正しいか確認
- Bundle ID とプロビジョニングプロファイルの確認

#### OCR エラー
- Document Intelligence の料金プランを確認（S0 推奨）
- アップロードされた画像のサイズ・形式を確認

### サポート情報

詳細は以下のガイドを参照：
- `AZURE_SETUP.md`: 完全セットアップガイド
- `azure/functions/DEPLOY.md`: デプロイ詳細手順
- `azure/functions/README.md`: API仕様

## 完了後の状態

✅ **完成後の機能**
- カメラで文書撮影
- Azure Document Intelligence による OCR
- Azure OpenAI による文書の構造化
- QR コード生成
- ローカル・クラウド保存
- 監査ログ